{"version":3,"file":"movable.js","sources":["movable.ts"],"sourcesContent":["import * as dom from \"web/dom\";\r\n\r\n/**\r\n * 创建一个可移动对象。\r\n * @param elem 要移动的元素。\r\n * @param options 移动的选项。\r\n * @return 返回一个移动对象。\r\n */\r\nexport default function movable(elem: HTMLElement, options?: Partial<Movable>) {\r\n    const r = new Movable();\r\n    r.elem = elem;\r\n    Object.assign(r, options).enable();\r\n    return r;\r\n}\r\n\r\n/**\r\n * 表示一个可移动的对象。\r\n */\r\nexport class Movable {\r\n\r\n    /**\r\n     * 移动的元素。\r\n     */\r\n    elem: HTMLElement;\r\n\r\n    /**\r\n     * 从指针按下到触发移动事件的等待毫秒数。如果为 -1 则忽略指针按下不动的操作。\r\n     * @default -1\r\n     */\r\n    delay: number;\r\n\r\n    /**\r\n     * 允许触发移动事件的最小指针移动距离（单位：像素）。当移动距离小于这个值时忽略移动操作。\r\n     * @default 3\r\n     */\r\n    distance: number;\r\n\r\n    /**\r\n     * 判断是否取消指定事件引发的移动效果。\r\n     * @param e 事件对象。\r\n     * @return 如果返回 true 则取消移动，否则允许开始移动。\r\n     * @desc 默认地，如果是点击输入域则取消移动。\r\n     */\r\n    cancel(e: MouseEvent) {\r\n        return e.target !== this.elem && /^(?:INPUT|TEXTAREA|BUTTON|SELECT|OPTION)/i.test((e.target as HTMLElement).tagName);\r\n    }\r\n\r\n    /**\r\n     * 启用移动效果。\r\n     */\r\n    enable() {\r\n        this.disable();\r\n        dom.on(this.elem, \"pointerdown\", this.handlePointerDown, this, { passive: false });\r\n    }\r\n\r\n    /**\r\n     * 禁用移动效果。\r\n     */\r\n    disable() {\r\n        dom.off(this.elem, \"pointerdown\", this.handlePointerDown, this, { passive: false });\r\n    }\r\n\r\n    /**\r\n     * 获取开始移动的水平坐标（单位：像素）。\r\n     */\r\n    startX: number;\r\n\r\n    /**\r\n     * 获取开始移动的垂直坐标（单位：像素）。\r\n     */\r\n    startY: number;\r\n\r\n    /**\r\n     * 获取当前的水平坐标（单位：像素）。\r\n     */\r\n    endX: number;\r\n\r\n    /**\r\n     * 获取当前的垂直坐标（单位：像素）。\r\n     */\r\n    endY: number;\r\n\r\n    /**\r\n     * 获取移动的水平距离（单位：像素）。\r\n     */\r\n    get offsetX() { return this.endX - this.startX; }\r\n\r\n    /**\r\n     * 获取移动的垂直距离（单位：像素）。\r\n     */\r\n    get offsetY() { return this.endY - this.startY; }\r\n\r\n    /**\r\n     * 当前正在移动的对象。\r\n     */\r\n    static current?: Movable;\r\n\r\n    /**\r\n     * 处理指针按下事件。\r\n     * @param e 事件对象。\r\n     */\r\n    protected handlePointerDown(e: MouseEvent) {\r\n        if (!e.button && !this.cancel(e)) {\r\n\r\n            // 不允许两个对象同时移动。\r\n            if (Movable.current) {\r\n                Movable.current.uninit(e);\r\n            }\r\n\r\n            // 记录开始位置。\r\n            this.endX = this.startX = e.pageX;\r\n            this.endY = this.startY = e.pageY;\r\n\r\n            // 设置下一次移动时初始化移动。\r\n            this._handler = this.init;\r\n\r\n            // 延时以避免将简单的点击作为移动处理。\r\n            this._timer = this.delay >= 0 ? setTimeout(() => {\r\n                this._timer = 0;\r\n                this._handler(e);\r\n            }, this.delay) : -1;\r\n\r\n            // 绑定指针移动和松开事件。\r\n            const doc = this.elem.ownerDocument;\r\n            dom.on(doc, \"pointerup\", this.handlePointerUp, this, { passive: true });\r\n            dom.on(doc, \"pointermove\", this.handlePointerMove, this, { passive: false });\r\n\r\n            // 禁用页面选择。\r\n            e.preventDefault();\r\n        }\r\n    }\r\n\r\n    /**\r\n     * 处理指针移动事件。\r\n     * @param e 事件对象。\r\n     */\r\n    protected handlePointerMove(e: MouseEvent) {\r\n\r\n        // 禁用页面滚动。\r\n        e.preventDefault();\r\n\r\n        // 更新当前的鼠标位置。\r\n        this.endX = e.pageX;\r\n        this.endY = e.pageY;\r\n\r\n        // 调用当前的处理句柄来处理此函数。\r\n        this._handler(e);\r\n    }\r\n\r\n    /**\r\n     * 处理指针松开事件。\r\n     * @param e 事件对象。\r\n     */\r\n    protected handlePointerUp(e: MouseEvent) {\r\n        if (!e.button) {\r\n            this.uninit(e);\r\n        }\r\n    }\r\n\r\n    /**\r\n     * 当前实际处理移动指针移动的函数。可能是 *init* 或 *move*。\r\n     */\r\n    private _handler: (e: MouseEvent) => void;\r\n\r\n    /**\r\n     * 开始移动的计时器。\r\n     */\r\n    private _timer: any;\r\n\r\n    /**\r\n     * 进入移动状态。\r\n     * @param e 事件对象。\r\n     */\r\n    protected init(e: MouseEvent) {\r\n        // 进入移动状态有两种可能：\r\n        // 1. 鼠标按下并移动，触发 pointermove 事件，此时 _timer 为等待超时的计时器。\r\n        // 2. 鼠标按下且不动时间超过 delay，触发 setTimeout，此时 _timer 为 0。\r\n        if (this._timer) {\r\n            // 如果移动距离过小，则不进入移动状态。\r\n            if (this.offsetX ** 2 + this.offsetY ** 2 < this.distance ** 2) {\r\n                return;\r\n            }\r\n            clearTimeout(this._timer);\r\n            this._timer = 0;\r\n        }\r\n\r\n        // 更新当前正在移动的对象。\r\n        Movable.current = this;\r\n\r\n        // 锁定全局样式。\r\n        this._originalCursor = document.documentElement.style.cursor;\r\n        document.documentElement.style.cursor = dom.getStyle(this.elem, \"cursor\");\r\n        this._originalPointerEvents = document.body.style.pointerEvents;\r\n        document.body.style.pointerEvents = \"none\";\r\n        if ((document.body as any).setCapture) {\r\n            (document.body as any).setCapture();\r\n        }\r\n\r\n        // 开始移动，并允许强制撤销移动操作。\r\n        if (this.moveStart(e) === false) {\r\n            this.uninit(e);\r\n            return;\r\n        }\r\n\r\n        // 移动。\r\n        this._handler = this.move;\r\n        this.move(e);\r\n    }\r\n\r\n    /**\r\n     * 退出移动状态。\r\n     * @param e 事件对象。\r\n     */\r\n    protected uninit(e: MouseEvent) {\r\n\r\n        // 解绑全局指针松开事件。\r\n        const doc = this.elem.ownerDocument;\r\n        dom.off(doc, \"pointermove\", this.handlePointerMove, this, { passive: false });\r\n        dom.off(doc, \"pointerup\", this.handlePointerUp, this, { passive: true });\r\n\r\n        // 清空计时器。\r\n        if (this._timer) {\r\n            clearTimeout(this._timer);\r\n            this._timer = 0;\r\n        }\r\n\r\n        if (Movable.current === this) {\r\n\r\n            // 恢复全局样式。\r\n            document.documentElement.style.cursor = this._originalCursor;\r\n            document.body.style.pointerEvents = this._originalPointerEvents;\r\n            if ((document.body as any).releaseCapture) {\r\n                (document.body as any).releaseCapture();\r\n            }\r\n\r\n            // 结束移动。\r\n            this.moveEnd(e);\r\n            Movable.current = undefined;\r\n        }\r\n\r\n    }\r\n\r\n    /**\r\n     * 移动前鼠标样式。\r\n     */\r\n    private _originalCursor: string | null;\r\n\r\n    /**\r\n     * 移动前指针事件。\r\n     */\r\n    private _originalPointerEvents: string | null;\r\n\r\n    /**\r\n     * 触发移动开始事件。\r\n     * @param e 事件对象。\r\n     * @return 如果返回 false 则忽略本次移动。\r\n     */\r\n    moveStart(e: MouseEvent): boolean | void { }\r\n\r\n    /**\r\n     * 触发移动事件。\r\n     * @param e 事件对象。\r\n     */\r\n    move(e: MouseEvent) { }\r\n\r\n    /**\r\n     * 触发移动结束事件。\r\n     * @param e 事件对象。\r\n     */\r\n    moveEnd(e: MouseEvent) { }\r\n\r\n}\r\n\r\nMovable.prototype.delay = -1;\r\nMovable.prototype.distance = 3;\r\n"],"mappings":"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"}