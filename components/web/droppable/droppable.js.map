{"version":3,"file":"droppable.js","sources":["droppable.ts"],"sourcesContent":["import { getRect } from \"web/dom\";\r\nimport { Draggable } from \"web/draggable\";\r\n\r\n/**\r\n * 创建一个可拖放区域。\r\n * @param elem 要拖放的元素。\r\n * @param options 拖放的选项。\r\n * @return 返回一个可拖放区域。\r\n */\r\nexport default function droppable(elem: HTMLElement, options?: Partial<Droppable>) {\r\n    const r = new Droppable();\r\n    r.elem = elem;\r\n    Object.assign(r, options).enable();\r\n    return r;\r\n}\r\n\r\n/**\r\n * 表示一个可拖放区域。\r\n */\r\nexport class Droppable {\r\n\r\n    /**\r\n     * 任意元素拖动开始事件。\r\n     * @param draggable 当前的拖动元素。\r\n     * @param e 事件对象。\r\n     * @param sender 事件源。\r\n     * @return 如果返回 false 则当前拖动区域不响应指定元素的拖放相关事件。\r\n     */\r\n    onDragStart?: (draggable: Draggable, e: MouseEvent, sender: this) => boolean | void;\r\n\r\n    /**\r\n     * 拖动进入事件。\r\n     * @param draggable 当前的拖动元素。\r\n     * @param e 事件对象。\r\n     * @param sender 事件源。\r\n     * @return 如果返回 false 则忽略本次拖动进入操作。\r\n     */\r\n    onDragEnter?: (draggable: Draggable, e: MouseEvent, sender: this) => boolean | void;\r\n\r\n    /**\r\n     * 在当前区域拖动移动事件。\r\n     * @param draggable 当前的拖动元素。\r\n     * @param e 事件对象。\r\n     * @param sender 事件源。\r\n     */\r\n    onDragMove?: (draggable: Draggable, e: MouseEvent, sender: this) => void;\r\n\r\n    /**\r\n     * 拖动离开事件。\r\n     * @param draggable 当前的拖动元素。\r\n     * @param e 事件对象。\r\n     * @param sender 事件源。\r\n     * @return 如果返回 false 则忽略本次拖动离开操作。\r\n     */\r\n    onDragLeave?: (draggable: Draggable, e: MouseEvent, sender: this) => boolean | void;\r\n\r\n    /**\r\n     * 拖放事件。\r\n     * @param draggable 当前的拖动元素。\r\n     * @param e 事件对象。\r\n     * @param sender 事件源。\r\n     */\r\n    onDrop?: (draggable: Draggable, e: MouseEvent, sender: this) => void;\r\n\r\n    /**\r\n     * 任意元素拖动结束事件。\r\n     * @param draggable 当前的拖动元素。\r\n     * @param e 事件对象。\r\n     * @param sender 事件源。\r\n     */\r\n    onDragEnd?: (draggable: Draggable, e: MouseEvent, sender: this) => void;\r\n\r\n    /**\r\n     * 拖放的元素。\r\n     */\r\n    elem: HTMLElement;\r\n\r\n    /**\r\n     * 启用拖放。\r\n     */\r\n    enable() {\r\n        const index = Droppable.instances.indexOf(this);\r\n        if (index < 0) {\r\n            Droppable.instances.push(this);\r\n        }\r\n    }\r\n\r\n    /**\r\n     * 禁用拖放。\r\n     */\r\n    disable() {\r\n        const index = Droppable.instances.indexOf(this);\r\n        if (index >= 0) {\r\n            Droppable.instances.splice(index, 1);\r\n        }\r\n    }\r\n\r\n    /**\r\n     * 所有拖放区域。\r\n     */\r\n    static instances: Droppable[] = [];\r\n\r\n    /**\r\n     * 本次拖动操作可拖放的所有区域。\r\n     */\r\n    static current: Droppable[] | null;\r\n\r\n    /**\r\n     * 处理拖动开始事件。\r\n     * @param e 事件对象。\r\n     * @param sender 事件源。\r\n     */\r\n    static handleDragStart(e: MouseEvent, sender: Draggable) {\r\n        Droppable.current = Droppable.instances.filter(droppable => !droppable.onDragStart || droppable.onDragStart(sender, e, droppable) !== false);\r\n    }\r\n\r\n    /**\r\n     * 处理拖动移动事件。\r\n     * @param e 事件对象。\r\n     * @param sender 事件源。\r\n     */\r\n    static handleDragMove(e: MouseEvent, sender: Draggable) {\r\n        for (const droppable of Droppable.current!) {\r\n            if (droppable.contains(sender, e)) {\r\n                if (droppable.active) {\r\n                    droppable.onDragMove && droppable.onDragMove(sender, e, droppable);\r\n                } else if (!droppable.onDragEnter || droppable.onDragEnter(sender, e, droppable) !== false) {\r\n                    droppable.active = true;\r\n                }\r\n            } else if (droppable.active && (!droppable.onDragLeave || droppable.onDragLeave(sender, e, droppable) !== false)) {\r\n                droppable.active = false;\r\n            }\r\n        }\r\n    }\r\n\r\n    /**\r\n     * 处理拖动结束事件。\r\n     * @param e 事件对象。\r\n     * @param sender 事件源。\r\n     */\r\n    static handleDragEnd(e: MouseEvent, sender: Draggable) {\r\n        for (const droppable of Droppable.current!) {\r\n            droppable.onDragEnd && droppable.onDragEnd(sender, e, droppable);\r\n            if (droppable.active) {\r\n                droppable.active = false;\r\n                droppable.onDrop && droppable.onDrop(sender, e, droppable);\r\n            }\r\n        }\r\n        Droppable.current = null;\r\n    }\r\n\r\n    /**\r\n     * 判断当前区域是否包含拖动对象。\r\n     */\r\n    protected active: boolean;\r\n\r\n    /**\r\n     * 判断指定的拖动对象是否已进入当前拖放区域。\r\n     * @param draggable 拖动对象。\r\n     * @param e 事件对象。\r\n     * @return 如果在区域内则返回 true，否则返回 false。\r\n     */\r\n    contains(draggable: Draggable, e: MouseEvent) {\r\n        const rect = getRect(this.elem);\r\n        return rect.x <= draggable.endX && draggable.endX <= rect.x + rect.width && rect.y <= draggable.endY && draggable.endY <= rect.y + rect.height;\r\n    }\r\n\r\n}\r\n\r\nfunction connect(dragEvent: string, dropEvent: string) {\r\n    const old = (Draggable.prototype as any)[dragEvent];\r\n    (Draggable.prototype as any)[dragEvent] = function (e: MouseEvent) {\r\n        const r = old.call(this, e);\r\n        (Droppable as any)[dropEvent](e, this);\r\n        return r;\r\n    };\r\n}\r\nconnect(\"moveStart\", \"handleDragStart\");\r\nconnect(\"move\", \"handleDragMove\");\r\nconnect(\"moveEnd\", \"handleDragEnd\");\r\n"],"mappings":"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"}